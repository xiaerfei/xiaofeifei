---
title: L5 å¤šå¤„ç†å™¨ç¼–ç¨‹ï¼šä»å…¥é—¨åˆ°æ”¾å¼ƒ
tags: æ“ä½œç³»ç»Ÿ
Mermaid: true
Mathjax: true
---
## çº¿ç¨‹æ ˆå¤§å°
å¯ä»¥é€šè¿‡ä¸‹é¢çš„ä»£ç æ¥æµ‹è¯•å½“å‰çº¿ç¨‹çš„æ ˆå¤§å°ï¼š

```c
#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include <stdatomic.h>
#include <assert.h>
#include <unistd.h>
#include <pthread.h>

#define NTHREAD 64
enum { T_FREE = 0, T_LIVE, T_DEAD, };
struct thread {
  int id, status;
  pthread_t thread;
  void (*entry)(int);
};

struct thread tpool[NTHREAD], *tptr = tpool;

void *wrapper(void *arg) {
  struct thread *thread = (struct thread *)arg;
  thread->entry(thread->id);
  return NULL;
}

void create(void *fn) {
  assert(tptr - tpool < NTHREAD);
  *tptr = (struct thread) {
    .id = tptr - tpool + 1,
    .status = T_LIVE,
    .entry = fn,
  };
  pthread_create(&(tptr->thread), NULL, wrapper, tptr);
  ++tptr;
}

void join() {
  for (int i = 0; i < NTHREAD; i++) {
    struct thread *t = &tpool[i];
    if (t->status == T_LIVE) {
      pthread_join(t->thread, NULL);
      t->status = T_DEAD;
    }
  }
}

__attribute__((destructor)) void cleanup() {
  join();
}
```

```c
#include "thread.h"
#include <stdint.h>

void * volatile low[64];
void * volatile high[64];

void update_range(int T, void *ptr) {
    if (ptr < low[T]) low[T] = ptr;
    if (ptr > high[T]) high[T] = ptr;
}

void probe(int T, int n) {
  update_range(T, &n);
  long sz = (uintptr_t)high[T] - (uintptr_t)low[T];
  if (sz % 1024 < 32) {
    printf("Stack(T%d) >= %ld KB\n", T, sz / 1024);
  }
  probe(T, n + 1);  // Infinite recursion
}

void Tprobe(int T) {
  low[T]  = (void *) - 1;
  high[T] = (void *)0;
  update_range(T, &T);
  probe(T, 0);
}

int main() {
  setbuf(stdout, NULL);
  for (int i = 0; i < 4; i++) {
    create(Tprobe);
  }
}
```

å¯ä»¥çœ‹åˆ°æ—¥å¿—å¦‚ä¸‹ï¼š

```shell
Stack(T1) >= 8169 KB
Stack(T1) >= 8171 KB
Stack(T1) >= 8172 KB
Stack(T1) >= 8174 KB
Stack(T1) >= 8175 KB
Stack(T1) >= 8177 KB
[1]    2133 segmentation fault (core dumped)  ./stack.out
```

åŸºæœ¬ä¸Šç¡®å®šæ˜¯ `8192 KB`

ç”¨ä¸‹é¢çš„ shell å‘½ä»¤ä¹Ÿå¯ä»¥æŸ¥çœ‹ï¼š

```shell
ulimit -s
# 8192
```
é€šè¿‡ `pthread` åˆ›å»ºçº¿ç¨‹çš„æ—¶å€™ï¼Œå¯ä»¥è®¾å®šæ ˆçš„å¤§å°ï¼Œå°† `thread.h` ä¸­å‡½æ•° `create` æ›´æ”¹å¦‚ä¸‹ï¼š

```c
void create(void *fn) {
  assert(tptr - tpool < NTHREAD);
  *tptr = (struct thread) {
    .id = tptr - tpool + 1,
    .status = T_LIVE,
    .entry = fn,
  };

  pthread_t thread_id;
  int ret ,stacksize = 10 * 1024 * 1024; /*thread å †æ ˆè®¾ç½®ä¸º10MBï¼Œstacksizeä»¥å­—èŠ‚ä¸ºå•ä½ã€‚*/
  pthread_attr_t attr;
  ret = pthread_attr_init(&attr); /*åˆå§‹åŒ–çº¿ç¨‹å±æ€§*/
  assert(ret == 0);
  ret = pthread_attr_setstacksize(&attr, stacksize);
  assert(ret == 0);

  pthread_create(&(tptr->thread), &attr, wrapper, tptr);
  ++tptr;
}
```

è¿™é‡Œå°†å½“å‰çº¿ç¨‹çš„å¤§å°æ›´æ”¹ä¸º `10MB`:

```shell
Stack(T3) >= 10218 KB
Stack(T3) >= 10220 KB
Stack(T3) >= 10221 KB
Stack(T3) >= 10223 KB
Stack(T3) >= 10224 KB
[1]    4033 segmentation fault (core dumped)  ./stack.out
```

## æ”¾å¼ƒ (1)ï¼šåŸå­æ€§
`å…±äº«å†…å­˜` å‘Šè¯‰æˆ‘ä»¬å¯¹äºå…¨å±€çš„å˜é‡ `x`ï¼Œå…¶å®ƒçº¿ç¨‹å¯ä»¥éšæ—¶æ›´æ”¹ `x` çš„å€¼ï¼Œå¯¼è‡´ä¸¤æ¬¡å¯èƒ½è¯»åˆ°ä¸åŒçš„ xï¼š

```c
int x = 0;
int Tworker() {
  printf("%d\n", x);  // Global x
  printf("%d\n", x);
}
```

å¦‚ä¸‹é¢æ±‚å’Œçš„ä¾‹å­ï¼š

```c
#define N 100000000
long sum = 0;

void Tsum() { for (int i = 0; i < N; i++) sum++; }

int main() {
  create(Tsum);
  create(Tsum);
  join();
  printf("sum = %ld\n", sum);
}
```

æ¯æ¬¡è®¡ç®—ç»“æœä¸å°½ç›¸åŒï¼š

```shell
âœ ./sum.out 
sum = 105627439
âœ ./sum.out
sum = 104261448
âœ ./sum.out
sum = 106720644
âœ ./sum.out
sum = 106128921
```
é€šè¿‡æŸ¥çœ‹åæ±‡ç¼–å¯ä»¥çœ‹åˆ°ï¼š

```c
0000000000001348 <Tsum>:
    1348:       f3 0f 1e fa             endbr64 
    134c:       55                      push   %rbp
    134d:       48 89 e5                mov    %rsp,%rbp
    1350:       c7 45 fc 00 00 00 00    movl   $0x0,-0x4(%rbp)
    1357:       eb 16                   jmp    136f <Tsum+0x27>
    1359:       48 8b 05 e0 32 00 00    mov    0x32e0(%rip),%rax        # 4640 <sum>
    1360:       48 83 c0 01             add    $0x1,%rax
    1364:       48 89 05 d5 32 00 00    mov    %rax,0x32d5(%rip)        # 4640 <sum>
    136b:       83 45 fc 01             addl   $0x1,-0x4(%rbp)
    136f:       81 7d fc ff e0 f5 05    cmpl   $0x5f5e0ff,-0x4(%rbp)
    1376:       7e e1                   jle    1359 <Tsum+0x11>
    1378:       90                      nop
    1379:       90                      nop
    137a:       5d                      pop    %rbp
    137b:       c3                      ret 
```

`Tsum` å‡½æ•°åŒ…å«äº†å¤šæ¡æŒ‡ä»¤å®ç° `sum++`ï¼ŒåŸå­æ€§è‡ªç„¶å°±ä¿è¯ä¸äº†ã€‚
å¦‚æœç”¨ `-O2` æ¥ç¼–è¯‘ï¼Œå¾ˆå¥‡æ€ªï¼Œå®ƒç¥å¥‡çš„å°±å¯¹äº†ï¼Œæ±‡ç¼–å¦‚ä¸‹ï¼š

```c
0000000000001230 <Tsum>:
    1230:       f3 0f 1e fa             endbr64 
    1234:       48 81 05 01 2e 00 00    addq   $0x5f5e100,0x2e01(%rip)        # 4040 <sum>
    123b:       00 e1 f5 05 
    123f:       c3                      ret 
```

`$0x5f5e100` æ­£å¥½æ˜¯ `N`ï¼Œç¼–è¯‘å™¨è·³è¿‡ `for å¾ªç¯`ç›´æ¥è®¡ç®—å‡ºäº†ç»“æœ ğŸ˜‚ ~~~

å¦‚æœç”¨ `-O1` æ¥ç¼–è¯‘ï¼Œå¾ˆå¥‡æ€ªï¼Œå®ƒç¥å¥‡çš„å°±é”™äº†ï¼Œæ±‡ç¼–å¦‚ä¸‹ï¼š

```c
00000000000011c3 <Tsum>:
    11c3:       f3 0f 1e fa             endbr64 
    // è¯»å–å…¨å±€ sum å€¼
    11c7:       48 8b 15 72 2e 00 00    mov    0x2e72(%rip),%rdx        # 4040 <sum>
    11ce:       48 8d 42 01             lea    0x1(%rdx),%rax
    11d2:       48 81 c2 01 e1 f5 05    add    $0x5f5e101,%rdx
    11d9:       48 89 c1                mov    %rax,%rcx
    11dc:       48 83 c0 01             add    $0x1,%rax
    11e0:       48 39 d0                cmp    %rdx,%rax
    11e3:       75 f4                   jne    11d9 <Tsum+0x16>
    // å°†ç»“æœå†™å› sum
    11e5:       48 89 0d 54 2e 00 00    mov    %rcx,0x2e54(%rip)        # 4040 <sum>
    11ec:       c3                      ret 
```

æ˜¾ç„¶ä¸¤ä¸ªçº¿ç¨‹ç¬¬ä¸€æ¬¡è¯»å– `sum` çš„å€¼éƒ½æ˜¯é›¶ï¼Œä¸­é—´è®¡ç®—å®Œæˆå†å†™å› `sum`ï¼Œæœ€ç»ˆç»“æœ `sum = 100000000`;

## æ”¾å¼ƒ (2)ï¼šæ‰§è¡Œé¡ºåº
ä¸Šé¢çš„ä¾‹å­è¯´æ˜äº†ç¼–è¯‘æˆæœ‰å¯èƒ½å¯¼è‡´æ‰§è¡Œçš„ç»“æœä¸ä¸€æ ·ï¼›ä¸‹é¢çš„ä¾‹å­ä¹Ÿè¯´æ˜çš„è¿™ç‚¹ï¼š

```c
while (!done);
// would be optimized to
if (!done) while (1);
```
### ä¿è¯æ‰§è¡Œé¡ºåº

- æ’å…¥ â€œä¸å¯ä¼˜åŒ–â€ ä»£ç å¦‚ï¼š
    ```c
    asm volatile ("" ::: "memory");
    ```
- æ ‡è®°å˜é‡ load/store ä¸ºä¸å¯ä¼˜åŒ–ï¼Œä½¿ç”¨ volatile å˜é‡å¦‚ï¼š
    ```c
    extern int volatile done;

    while (!done) ;
    ```

å¦‚æœæœ‰è¿™æ ·çš„ä»£ç ï¼š

```c
int x = 0;
void Tsum() {
    int t = x;
    t = x;
}
```
é‚£ä¹ˆç¼–è¯‘å™¨å®Œå…¨æœ‰å¯èƒ½ä¼šå°†ç¬¬äºŒè¡Œ `t = x` ç§»é™¤æ‰ï¼Œå¦‚æœæ’å…¥ä¸å¯ä¼˜åŒ–ï¼š

```c
int x = 0;
void Tsum() {
    int t = x;
    asm volatile ("" ::: "memory");
    t = x;
}
```
ç°åœ¨ç¼–è¯‘å™¨å°±ä¸ä¼šå°†ç¬¬äºŒè¡Œ `t = x` ç§»é™¤æ‰äº†ã€‚

## æ”¾å¼ƒ (3)ï¼šå¤„ç†å™¨é—´çš„å¯è§æ€§




## å‚è€ƒ

[5. å¤šå¤„ç†å™¨ç¼–ç¨‹ï¼šä»å…¥é—¨åˆ°æ”¾å¼ƒ](https://jyywiki.cn/OS/2023/build/lect5.ipynb)